# News Article Generation Service Plan

## Overview

This plan describes the implementation of a new backend service that generates full news articles in markdown format from article outlines. The service reads outline JSON files generated by the news outline generation service, retrieves full text content for all related link IDs, stitches them together, and uses Qwen API to generate a complete article.

**Status**: Planning phase - not yet implemented

**Date**: 2025-11-20

---

## Objectives

1. **Create a new backend service** for news article generation (separate from research functions, part of news service)
2. **Read article outlines** from JSON files in `data/news/outlines/`
3. **Retrieve full content** for each `related_link_id` from batch directories
4. **Stitch content together** in a structured format
5. **Generate full article** in markdown format using Qwen API
6. **Output structured markdown** files to `data/news/articles/`
7. **Use configuration-driven approach**: All paths and model settings from `config.yaml`
8. **Dedicated prompts**: All prompts stored in dedicated files (not hardcoded)

---

## Architecture

### Service Components

```
backend/app/
├── services/
│   ├── news_outline_service.py        # Existing outline service
│   └── news_article_service.py        # NEW - Main article generation logic
└── routes/
    └── news.py                         # API endpoints (extend existing)
```

### Data Flow

```
Outline JSON (data/news/outlines/{outline_id}.json)
    │
    ├─ Read outline: title, description, related_link_ids
    │
    ▼
For each related_link_id:
    │
    ├─ Find batch JSON file (data/research/batches/run_{batch_id}/{batch_id}_{link_id}_complete.json)
    ├─ Extract full content:
    │   ├─ transcript (for videos)
    │   └─ content (for articles)
    │
    ▼
Stitch Content Together
    │
    ├─ Combine all transcript/content text
    ├─ Structure by link_id
    ├─ Include outline info
    │
    ▼
News Article Service
    │
    ├─ Load prompt from dedicated file
    ├─ Format content pack for Qwen
    ├─ Call Qwen API (qwen-plus model)
    │
    ▼
Generate Article (Markdown)
    │
    ├─ Parse markdown response from Qwen
    ├─ Validate structure
    │
    ▼
Save to data/news/articles/
```

---

## Directory Structure

### New Directories

```
data/
└── news/
    ├── channels                      # Existing
    ├── outlines/                     # Existing - Generated outlines
    └── articles/                     # NEW - Store generated articles
        └── {article_id}.md           # Markdown article files

news/                                 # Existing - News-specific prompts
└── prompts/
    ├── article_outline/              # Existing - Outline generation prompts
    │   ├── system.md
    │   └── instructions.md
    └── article_generation/           # NEW - Article generation prompts
        ├── system.md                 # System prompt for article generation
        └── instructions.md           # Detailed instructions for AI
```

---

## Configuration (config.yaml)

### New Configuration Sections

Add to existing `news` section in `config.yaml`:

```yaml
news:
  # Path configuration for news functions
  paths:
    outlines_dir: 'data/news/outlines'              # Existing
    batch_source_dir: 'data/research/batches'       # Existing
    articles_dir: 'data/news/articles'              # NEW - Where article markdown files are saved
  
  # AI model configuration for news article generation
  article_generation:                               # NEW - Article generation config
    model: 'qwen-plus'                              # Use qwen-plus model
    temperature: 0.7
    max_tokens: 16000                               # Higher token limit for full articles
    api_key: null                                   # Falls back to qwen.api_key if null
    language: 'zh-CN'                               # Output language
  
  # Prompt configuration
  prompts:
    base_dir: 'news/prompts'                        # Existing
    article_outline:                                # Existing
      system_prompt_path: 'news/prompts/article_outline/system.md'
      instructions_path: 'news/prompts/article_outline/instructions.md'
    article_generation:                             # NEW - Article generation prompts
      system_prompt_path: 'news/prompts/article_generation/system.md'
      instructions_path: 'news/prompts/article_generation/instructions.md'
```

### Configuration Access Pattern

```python
# Service initialization
config = Config()
news_config = config.get('news', {})
article_config = news_config.get('article_generation', {})
paths_config = news_config.get('paths', {})
prompts_config = news_config.get('prompts', {})

# Get model settings
model = article_config.get('model', 'qwen-plus')
temperature = article_config.get('temperature', 0.7)
max_tokens = article_config.get('max_tokens', 16000)

# Get paths
articles_dir = Path(paths_config.get('articles_dir', 'data/news/articles'))
outlines_dir = Path(paths_config.get('outlines_dir', 'data/news/outlines'))
batch_source_dir = Path(paths_config.get('batch_source_dir', 'data/research/batches'))

# Get prompt paths
article_gen_config = prompts_config.get('article_generation', {})
system_prompt_path = Path(article_gen_config.get('system_prompt_path'))
```

---

## Input Format

### Outline JSON Structure

Reference: `data/news/outlines/{outline_id}.json`

```json
{
  "outline_id": "outline_20251120_120415_001",
  "generated_at": "2025-11-20T20:15:30.123456",
  "batch_id": "20251120_120414",
  "article": {
    "title": "文章标题",
    "description": "文章描述/摘要",
    "related_link_ids": [
      "bili_req1",
      "yt_req2",
      "article_req3"
    ]
  },
  "metadata": {
    "model_used": "qwen-plus",
    "prompt_version": "v1.0",
    "source_batch": "20251120_120414",
    "total_sources": 3
  }
}
```

### Batch JSON Structure

Reference: `data/research/batches/run_{batch_id}/{batch_id}_{link_id}_complete.json`

```json
{
  "batch_id": "20251120_120414",
  "link_id": "bili_req1",
  "source": "bilibili",
  "metadata": {
    "title": "视频标题",
    "author": "作者名称",
    "url": "https://www.bilibili.com/video/BV1VYtwz2EP4/",
    "word_count": 7762,
    "publish_date": ""
  },
  "transcript": "完整转录文本...",  // For videos (bilibili, youtube)
  "content": "完整文章内容...",     // For articles
  "comments": null,
  "summary": {
    "transcript_summary": {...},
    "comments_summary": {},
    "created_at": "2025-11-20T20:05:53.347094",
    "model_used": "qwen-flash"
  },
  "completed_at": 1763640365.5558236
}
```

### Content Extraction Logic

For each `related_link_id`:
1. Find corresponding batch JSON file
2. Extract:
   - **For videos** (bilibili, youtube): `transcript` field
   - **For articles**: `content` field
3. Handle missing files gracefully (log warning, skip)
4. Handle missing content fields (use empty string if not found)

---

## Output Format

### Generated Article Structure

Saved as: `data/news/articles/{article_id}.md`

**Markdown format** (example):

```markdown
# 文章标题

> **摘要**: 文章描述/摘要

---

## 引言

[AI生成的引言内容，介绍文章主题和背景]

## 正文

### 第一个要点

[基于第一个来源的内容展开]

**来源**: [来源ID]

### 第二个要点

[基于第二个来源的内容展开]

**来源**: [来源ID]

### 第三个要点

[基于第三个来源的内容展开]

**来源**: [来源ID]

## 分析与讨论

[AI生成的分析和讨论内容]

## 结论

[AI生成的结论内容]

---

**相关来源ID**:
- 来源1_ID
- 来源2_ID
- 来源3_ID

**生成时间**: 2025-11-20T20:30:45.123456
**大纲ID**: outline_20251120_120415_001
**批次ID**: 20251120_120414
```

### Article Metadata JSON

Saved alongside markdown as: `data/news/articles/{article_id}.json`

```json
{
  "article_id": "article_20251120_203045_001",
  "outline_id": "outline_20251120_120415_001",
  "generated_at": "2025-11-20T20:30:45.123456",
  "batch_id": "20251120_120414",
  "title": "文章标题",
  "description": "文章描述/摘要",
  "markdown_file": "article_20251120_203045_001.md",
  "related_link_ids": [
    "bili_req1",
    "yt_req2",
    "article_req3"
  ],
  "metadata": {
    "model_used": "qwen-plus",
    "prompt_version": "v1.0",
    "total_sources": 3,
    "article_word_count": 0  # To be populated after generation
  }
}
```

### Output File Naming

- Pattern: `{article_id}.md` and `{article_id}.json`
- Location: `data/news/articles/{article_id}.md` and `{article_id}.json`
- Article ID format: `article_{timestamp}_{sequence}` (e.g., `article_20251120_203045_001`)

---

## Service Implementation

### NewsArticleService Class

```python
# backend/app/services/news_article_service.py

class NewsArticleService:
    """Service for generating news articles from outlines using full content."""
    
    def __init__(self, config: Config):
        self.config = config
        self._qwen_client: Optional[QwenStreamingClient] = None
        self._load_config()
    
    def _load_config(self):
        """Load configuration from config.yaml."""
        news_config = self.config.get('news', {})
        self.article_config = news_config.get('article_generation', {})
        self.paths_config = news_config.get('paths', {})
        self.prompts_config = news_config.get('prompts', {})
        
        # Initialize paths
        project_root = find_project_root() if find_project_root else Path.cwd()
        articles_dir_str = self.paths_config.get('articles_dir', 'data/news/articles')
        outlines_dir_str = self.paths_config.get('outlines_dir', 'data/news/outlines')
        batch_source_dir_str = self.paths_config.get('batch_source_dir', 'data/research/batches')
        
        # Convert to Path objects (handle absolute/relative)
        self.articles_dir = Path(articles_dir_str) if Path(articles_dir_str).is_absolute() else project_root / articles_dir_str
        self.outlines_dir = Path(outlines_dir_str) if Path(outlines_dir_str).is_absolute() else project_root / outlines_dir_str
        self.batch_source_dir = Path(batch_source_dir_str) if Path(batch_source_dir_str).is_absolute() else project_root / batch_source_dir_str
        
        # Create directories if needed
        self.articles_dir.mkdir(parents=True, exist_ok=True)
    
    def _get_qwen_client(self) -> QwenStreamingClient:
        """Get or create Qwen client."""
        if self._qwen_client is None:
            api_key = self.article_config.get('api_key') or self.config.get('qwen.api_key')
            model = self.article_config.get('model', 'qwen-plus')
            self._qwen_client = QwenStreamingClient(api_key=api_key, model=model)
        return self._qwen_client
    
    def _load_prompt(self, prompt_type: str = 'system') -> str:
        """Load prompt from dedicated file."""
        # Implementation: Load from news/prompts/article_generation/
        pass
    
    def _load_outline(self, outline_id: str) -> Dict[str, Any]:
        """Load outline JSON by ID."""
        # Implementation: Read from data/news/outlines/{outline_id}.json
        pass
    
    def _find_batch_file(self, batch_id: str, link_id: str) -> Optional[Path]:
        """Find batch JSON file for a given link_id."""
        # Implementation: Search in data/research/batches/run_{batch_id}/
        pass
    
    def _extract_content_from_batch_file(self, batch_file: Path) -> str:
        """Extract full content from batch JSON file."""
        # Implementation: Extract transcript (for videos) or content (for articles)
        pass
    
    def _retrieve_all_content(self, outline: Dict[str, Any]) -> List[str]:
        """Retrieve full content for all related_link_ids."""
        # Implementation: For each link_id, find file and extract transcript/content text
        pass
    
    def _stitch_content(self, outline: Dict[str, Any], content_texts: List[str]) -> str:
        """Stitch all content together in structured format for prompt."""
        # Implementation: Format outline + stitched content text for AI prompt
        pass
    
    def _generate_article(self, content_pack: str) -> str:
        """Call Qwen API to generate article in markdown format."""
        # Implementation: Build prompt, call Qwen, return markdown
        pass
    
    def generate_article_from_outline(
        self, 
        outline_id: str
    ) -> Dict[str, Any]:
        """Generate article from an outline."""
        # Implementation: Main orchestration method
        pass
    
    def save_article(self, article: Dict[str, Any], markdown_content: str) -> Tuple[Path, Path]:
        """Save generated article (markdown + metadata JSON)."""
        # Implementation: Save to data/news/articles/
        pass
    
    def load_article(self, article_id: str) -> Dict[str, Any]:
        """Load article metadata by ID."""
        # Implementation: Read JSON metadata file
        pass
    
    def get_article_markdown(self, article_id: str) -> str:
        """Get article markdown content by ID."""
        # Implementation: Read markdown file
        pass
```

---

## API Routes

### FastAPI Endpoint Extensions

Extend existing `backend/app/routes/news.py`:

```python
# backend/app/routes/news.py

# Existing imports...

# NEW: Article generation models
class GenerateArticleRequest(BaseModel):
    outline_id: str

class GenerateArticleResponse(BaseModel):
    status: Literal["success", "error"]
    article_id: Optional[str] = None
    article: Optional[Dict[str, Any]] = None
    error: Optional[str] = None

# NEW: Article endpoints
@router.post("/articles/generate", response_model=GenerateArticleResponse)
async def generate_article(request: GenerateArticleRequest):
    """Generate news article from outline."""
    # Implementation
    pass

@router.get("/articles/{article_id}")
async def get_article(article_id: str):
    """Get article metadata by ID."""
    # Implementation
    pass

@router.get("/articles/{article_id}/markdown")
async def get_article_markdown(article_id: str):
    """Get article markdown content by ID."""
    # Implementation
    pass

@router.get("/articles")
async def list_articles(outline_id: Optional[str] = None, batch_id: Optional[str] = None):
    """List all generated articles, optionally filtered by outline_id or batch_id."""
    # Implementation
    pass
```

---

## Prompt Design

### System Prompt (`news/prompts/article_generation/system.md`)

```markdown
你是一个专业的新闻文章撰写助手。你的任务是根据提供的大纲和完整内容，生成一篇结构完整、内容丰富、逻辑清晰的新闻文章。

## 你的任务

1. 阅读文章大纲（包括标题、描述和相关来源）
2. 阅读并理解所有相关来源的完整内容
3. 基于大纲和内容，撰写一篇完整的新闻文章
4. 确保文章结构清晰、内容丰富、逻辑连贯
5. 在适当位置引用来源信息
6. 输出标准Markdown格式

## 输出要求

- 必须以Markdown格式输出
- 必须包含标题（使用 #）
- 必须包含摘要（使用引用块 >）
- 必须包含引言、正文、分析和结论等部分
- 在适当位置标明来源信息
- 使用适当的Markdown格式化（标题、列表、强调等）

## 注意事项

- 文章应该基于提供的完整内容，而不是仅基于摘要
- 确保信息准确，避免编造内容
- 保持客观、专业的新闻写作风格
- 合理组织内容，确保逻辑清晰
- 适当使用Markdown格式增强可读性
```

### Instructions Prompt (`news/prompts/article_generation/instructions.md`)

```markdown
# 新闻文章生成详细说明

## 输入数据格式

你会收到以下信息：

### 文章大纲
- **标题**: 文章标题
- **描述**: 文章描述/摘要
- **相关来源ID**: 相关内容的链接ID列表

### 完整内容

对于每个相关来源，你会收到：
- **来源ID**: 链接标识符
- **完整内容**: 转录文本（视频）或文章内容（文章）

## 生成逻辑

1. **理解大纲**: 仔细阅读文章大纲，理解文章的主题和目标
2. **阅读内容**: 详细阅读所有来源的完整内容，提取关键信息
3. **组织结构**: 
   - 引言：介绍主题和背景
   - 正文：按逻辑组织要点，每个要点可以对应一个或多个来源
   - 分析：基于内容进行深入分析和讨论
   - 结论：总结要点和观点
4. **引用来源**: 在适当位置标注信息来源
5. **格式输出**: 使用Markdown格式输出完整文章

## Markdown格式要求

- 使用 `#` 作为文章主标题
- 使用 `> **摘要**: ...` 作为文章摘要
- 使用 `##` 作为主要章节标题
- 使用 `###` 作为小节标题
- 使用 `**来源**: ...` 标注信息来源
- 使用 `---` 作为分隔线
- 使用列表组织相关链接
- 适当使用强调和格式化

## 质量标准

- **准确性**: 确保信息准确，基于提供的内容
- **完整性**: 覆盖大纲中的所有要点
- **逻辑性**: 文章结构清晰，逻辑连贯
- **可读性**: 使用适当的格式和分段，易于阅读
- **专业性**: 保持客观、专业的新闻写作风格

## 输出示例结构

```markdown
# 文章标题

> **摘要**: 文章描述/摘要

---

## 引言

[引言内容]

## 正文

### 第一个要点

[基于来源内容的展开]

**来源**: [来源ID]

### 第二个要点

[基于来源内容的展开]

**来源**: [来源ID]

## 分析与讨论

[分析和讨论内容]

## 结论

[结论内容]

---

**相关来源ID**:
- 来源1_ID
- 来源2_ID

**生成时间**: [时间戳]
**大纲ID**: [outline_id]
**批次ID**: [batch_id]
```

---

## Implementation Steps

### Phase 1: Configuration Setup
1. Add `article_generation` section to `news` config in `config.yaml`
2. Add `articles_dir` to `news.paths` configuration
3. Add `article_generation` to `news.prompts` configuration
4. Define AI model configuration for article generation

### Phase 2: Directory Structure
1. Create `data/news/articles/` directory
2. Create `news/prompts/article_generation/` directory
3. Create prompt files (`system.md`, `instructions.md`)

### Phase 3: Service Implementation
1. Create `NewsArticleService` class
2. Implement configuration loading
3. Implement outline loading from JSON files
4. Implement batch file finding logic
5. Implement content extraction from batch files
6. Implement content retrieval for all link IDs
7. Implement content stitching logic
8. Implement prompt loading from files
9. Implement Qwen API integration
10. Implement markdown parsing and validation
11. Implement article saving (markdown + JSON metadata)

### Phase 4: API Routes
1. Extend `backend/app/routes/news.py` with article endpoints
2. Implement `/api/news/articles/generate` endpoint
3. Implement `/api/news/articles/{article_id}` endpoint
4. Implement `/api/news/articles/{article_id}/markdown` endpoint
5. Implement `/api/news/articles` listing endpoint

### Phase 5: Error Handling & Validation
1. Handle missing outline files
2. Handle missing batch files for link IDs
3. Handle missing content fields in batch files
4. Handle invalid Qwen responses
5. Validate markdown structure
6. Add logging for debugging

### Phase 6: Testing
1. Unit tests for service methods
2. Integration tests for API endpoints
3. Test with real outline and batch data
4. Test error scenarios

---

## Dependencies

### Existing Dependencies (Already Available)
- `fastapi` - API framework
- `pydantic` - Data validation
- `loguru` - Logging
- `research.client.QwenStreamingClient` - Qwen API client
- `core.config.Config` - Configuration management

### No New Dependencies Required
All necessary dependencies are already available in the project.

---

## Error Handling

### Common Error Scenarios

1. **Missing Outline File**
   - Error: Outline JSON file not found
   - Handling: Return error with clear message, suggest checking outline_id

2. **Missing Batch Files**
   - Error: Batch JSON file not found for one or more link_ids
   - Handling: Log warning for missing files, continue with available content

3. **Missing Content Fields**
   - Error: Batch file exists but missing `transcript` or `content` field
   - Handling: Log warning, use empty string, continue processing

4. **Invalid Qwen Response**
   - Error: Qwen returns non-markdown or malformed content
   - Handling: Log raw response, return error, optionally retry with reformatted prompt

5. **Content Too Large**
   - Error: Combined content exceeds token limits
   - Handling: Truncate content with warning, prioritize earlier sources

6. **Configuration Errors**
   - Error: Missing required config values
   - Handling: Use sensible defaults, log warnings

7. **File System Errors**
   - Error: Cannot create directories or write files
   - Handling: Check permissions, return error with actionable message

---

## Logging

### Log Points

```python
logger.info(f"Loading outline: {outline_id}")
logger.info(f"Retrieving content for {len(related_link_ids)} sources")
logger.debug(f"Found batch file for {link_id}: {batch_file}")
logger.warning(f"Batch file not found for {link_id}, skipping")
logger.warning(f"Content field missing for {link_id}, using empty content")
logger.info(f"Retrieved {len(content_items)} content items")
logger.info(f"Total content size: {total_words} words")
logger.info(f"Generating article with Qwen ({model})...")
logger.info(f"Generated article saved: {article_id}")
logger.error(f"Failed to generate article: {error}")
```

---

## Future Enhancements (Out of Scope)

These are potential future improvements but not part of the initial implementation:

1. **Article Versioning**: Track different versions of articles
2. **Article Editing**: Allow manual editing of generated articles
3. **Template Support**: Support different article templates/styles
4. **Multi-language Support**: Generate articles in different languages
5. **Content Filtering**: Filter or prioritize certain types of content
6. **Citation Management**: Enhanced citation formatting and management
7. **Article Preview**: Preview articles before saving
8. **Batch Article Generation**: Generate multiple articles at once
9. **Content Summarization**: Summarize very long content before stitching
10. **Image Integration**: Include images from sources in articles

---

## Testing Strategy

### Unit Tests

```python
# tests/test_news_article_service.py

def test_load_outline():
    """Test loading outline from JSON file."""
    pass

def test_find_batch_file():
    """Test finding batch file for link_id."""
    pass

def test_extract_content_from_batch_file():
    """Test extracting content from batch file."""
    pass

def test_retrieve_all_content():
    """Test retrieving content for all link IDs."""
    pass

def test_stitch_content():
    """Test stitching content together."""
    pass

def test_load_prompt():
    """Test loading prompts from dedicated files."""
    pass

def test_generate_article():
    """Test article generation with mock Qwen response."""
    pass

def test_save_article():
    """Test saving article (markdown + JSON)."""
    pass
```

### Integration Tests

```python
# tests/test_news_api.py

def test_generate_article_endpoint():
    """Test API endpoint for article generation."""
    pass

def test_get_article_endpoint():
    """Test API endpoint for retrieving article."""
    pass

def test_get_article_markdown_endpoint():
    """Test API endpoint for retrieving article markdown."""
    pass

def test_list_articles_endpoint():
    """Test API endpoint for listing articles."""
    pass
```

### Manual Testing Steps

1. **Prepare Test Data**
   - Ensure outline JSON file exists in `data/news/outlines/`
   - Verify outline contains `related_link_ids`
   - Ensure corresponding batch JSON files exist

2. **Test Service**
   - Call `generate_article_from_outline()` with a valid outline_id
   - Verify article markdown is generated correctly
   - Verify article is saved to `data/news/articles/` (both .md and .json)

3. **Test API**
   - POST to `/api/news/articles/generate` with outline_id
   - Verify response contains valid article_id
   - GET `/api/news/articles/{article_id}` to retrieve metadata
   - GET `/api/news/articles/{article_id}/markdown` to retrieve markdown
   - GET `/api/news/articles?outline_id={outline_id}` to list articles

---

## Notes

1. **Separation from Research Functions**: This service is intentionally part of the news workflow, not research workflow. It uses batch data as input but serves the news article generation purpose.

2. **Configuration-Driven**: All paths, model settings, and prompt paths are configurable via `config.yaml` to maintain flexibility and avoid hardcoding.

3. **Prompt Files**: All prompts are stored in dedicated markdown files in `news/prompts/article_generation/` directory, following the same pattern as outline generation prompts.

4. **Content Handling**: The service handles different content types (transcript for videos, content for articles) automatically. Only the raw text content is extracted and stitched together - no metadata is extracted or included in the content sent to AI.

5. **Error Resilience**: The service should continue processing even if some link_ids cannot be resolved, logging warnings but generating article with available content.

6. **Markdown Output**: Articles are generated in Markdown format for easy rendering and editing, with metadata stored separately in JSON.

7. **Content Stitching**: Content from multiple sources is stitched together as raw text (transcript/content fields only), allowing the AI to generate coherent articles. Source attribution in the generated article (link_ids) comes from the outline.

---

## Approval Checklist

Before implementation begins, confirm:

- [x] Plan document created
- [ ] Architecture reviewed
- [ ] Configuration structure approved
- [ ] Output format confirmed
- [ ] Prompt design reviewed
- [ ] API endpoints approved
- [ ] Directory structure confirmed
- [ ] Error handling strategy approved

---

**Next Steps**: Once this plan is approved, proceed with implementation following the phases outlined above.

