# 研究工作流右侧交互栏规划（Phase 0.5~4 通用）

## 背景与目标
- 现有交互栏方案仅在 Phase 3 引入，Phase 0.5/1/2/4 仍缺乏实时反馈与输入通道，体验不一致。
- 研究工作流全程需要持续的“动态反馈 + 用户输入”空间，用于展示流式 Token、系统提示、用户操作历史。
- 目标：打造贯穿各阶段的统一右侧交互栏，让主内容区聚焦结构化成果，右侧轨道负责实时互动、状态提示、输入指令。

## 功能范围
- 实时流展示（全阶段）
  - 气泡式对话布局，区分角色（`AI 助手`、`我`、`系统`、`总结`），并附带阶段徽章（如 `Phase2Synthesize`、`Phase3Execute`、`Phase4Report`）。
  - Token 流统一以“正在输入…”动效呈现，summarization Token 另加“总结生成中”微标签；允许收藏或固定重要流。
- 用户输入（动态切换）
  - 底部输入框常驻，样式保持简洁，但根据阶段与提示类型调整文案、按钮、限制：
    - Phase 0.5/1：默认只读提示“AI 正在准备…”，当需要补充背景时开放填写。
    - Phase 2：鼓励补充案例或问题，文案如“补充资料或提问…”。
    - Phase 3：沿用研究确认流程（发送/停止/重试），支持确认、否决、定制反馈。
    - Phase 4：可扩展为“提出修改意见”“请求导出”等操作。
  - 输入框上方展示阶段限定提示或快捷键说明。
- 状态反馈
  - 顶部状态条：连接状态、延迟、当前研究阶段；阶段切换时弹出轻量状态卡片。
  - 在对话中穿插提醒（如 “阶段 2 已完成，正在进入阶段 3”）。
  - 网络断连或错误以浅色警示卡片提示，并提供“重连”或“重新发送”入口。

## 技术方案概述
- 布局与组件
  - 抽象通用布局容器：主列（结构化内容） + 侧列（交互栏）。
  - 提炼为 `WorkflowInteractionPanel` + `WorkflowInteractionInput` 组合组件，Phase 3 现有实现迁移并扩展。
  - 支持在移动端折叠为底部抽屉。
- 状态管理
  - `workflowStore.researchAgentStatus.streams` 保持统一数据源，扩展 `metadata.workflow_phase`、`metadata.prompt_type` 等字段。
  - 新增 `ui.interactionContext`（或映射函数）描述当前阶段允许的输入类型、按钮状态。
- 交互逻辑
  - `usePhase3Interaction` 升级为 `useWorkflowInteraction`，返回消息列表、状态、输入约束。
  - 按阶段决定 WebSocket `sendMessage` 的 type/payload（例如 `phase2:user_feedback`、`phase3:user_input`）。
  - 主列视图监听阶段事件，高亮当前阶段内容、联动提示条。
- 后端配合
  - 确认各阶段是否已有流式事件；如缺失，评估新增 SSE/WS 事件：阶段通知、总结 Token、错误提示等。
  - 统一事件命名与 metadata 结构，便于前端判断阶段与输入需求。

## 数据流（跨阶段）
1. WebSocket/SSE 推送事件 → `workflowStore.researchAgentStatus.streams`。
2. `useWorkflowInteraction` 读取 streams + 运行中阶段信息，生成消息视图模型。
3. 交互栏依据 `waitingForUser`、`prompt_type`、阶段等决定输入框状态与操作按钮。
4. 用户输入通过 `sendMessage` 发出，对应到不同的 backend handler；发送后在交互栏内本地回显。
5. 主列根据阶段完成/错误事件更新卡片状态与高亮。

## UI 结构示意（ASCII 草图）
```
┌─────────────────────────── 页面 ───────────────────────────┬────────────── 右侧对话区 ──────────────┐
│                                                           │                                           │
│  深度研究 - 分析步骤                                       │  ┌─ 状态栏 ─────────────────────────┐  │
│  ┌─────────────── Step 卡片 ────────────────┐              │  │ ● 已连接   延迟 120ms   重试 ↻    │  │
│  │ ① 构建六要素提示框架                           ▼ │      │  └──────────────────────────────────┘  │
│  │   • 摘要 ...                                     │      │                                           │
│  │   • 主要观点 ...                                 │      │  ┌─ 气泡对话 ─────────────────────┐  │
│  └──────────────────────────────────────────┘      │  │  🟡 AI 助手 · Phase2Synthesize        │  │
│  ...                                                │      │  │ “正在梳理关键洞察... ” ◣打字中◢ │  │
│                                                     │      │  🔵 我                             │  │
│                                                     │      │  │ “请聚焦供应链数据”              │  │
│                                                     │      │  🟡 总结 · Summarizing             │  │
│                                                     │      │  │ “阶段结论：...” ◣流式输出◢      │  │
│                                                     │      │  └───────────────────────────────┘  │
│                                                     │      │                                           │
│                                                     │      │  ┌─ 输入区 ───────────────────────┐  │
│                                                     │      │  │ 提问或指令...                 ▢ │  │
│                                                     │      │  │ [发送]  [停止]  [重试]           │  │
│                                                     │      │  └────────────────────────────────┘  │
└─────────────────────────────────────────────────────┴───────────────────────────────────────────────┘
```

## 中文标签需求对照
- 顶部状态：`已连接`、`延迟`
- 阶段提示：`阶段 2 已完成`、`进入阶段 3`
- 对话身份：`AI 助手`、`我`、`系统`、`总结`
- 阶段徽章：`Phase2Synthesize`、`Phase3Execute`、`Phase4Report`
- 输入区占位：`补充资料或提问...`、`提问或指令...`、`提交修改意见...`
- 操作按钮：`发送`、`停止`、`重试`、（可扩展）`下载报告`

## 关键任务
1. **框架改造**：抽取公共布局，确保 Phase 0.5~4 页面均加载交互栏。
2. **Store 扩展**：streams metadata + 输入上下文；定义 `interactionContext`。
3. **Hook 泛化**：`useWorkflowInteraction` 替代 Phase 3 专用 hook。
4. **输入控制器**：按阶段/提示类型动态渲染输入区文案、按钮、校验。
5. **事件协议对齐**：与后端确认并补齐阶段事件、summarization Token。
6. **视觉与动效统一**：确保右侧栏在所有阶段风格一致，支持夜间/移动适配。
7. **性能测试**：长流程下的滚动与渲染优化。
8. **QA 验证**：跨阶段场景、断线重连、阶段跳转下的交互一致性。

## 风险与缓解
- **阶段事件不完整**：需协调后端补齐，或在前端设默认消息占位。
- **输入权限混乱**：严格根据 `waitingForUser`、`prompt_type` 限制按钮，避免误操作。
- **移动端布局受限**：设计折叠/抽屉方案，确保核心功能可用。
- **滚动体验冲突**：提供“保持最新/锁定”切换，减少跳动。
- **性能瓶颈**：必要时引入虚拟列表、分段加载。

## 下一步
- 对齐后端事件结构与阶段支持范围。
- 更新交互栏原型，覆盖 Phase 0.5~4 场景。
- 拟定迭代计划：store & hook 泛化 → Phase 2 接入 → 其余阶段 → 移动端适配。
- 评估工程量与发布节奏，安排逐步上线策略。
