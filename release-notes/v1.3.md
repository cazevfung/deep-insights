## 1.3 版本发布

### 亮点

- **语义向量检索系统** - Phase 3 研究阶段新增强大的语义搜索能力，支持基于向量嵌入的智能内容检索。AI 可自动识别相关概念和主题，即使关键词不完全匹配也能找到相关内容，大幅提升研究深度和准确性。

- **增强的 Phase 3 输出架构** - 重构 Phase 3 执行阶段的输出结构，新增 `findings.article` 字段，要求 AI 在"重要发现"与"深入分析"之间插入完整文章，提供更系统化的研究分析。优化条件性输出逻辑，避免在请求更多上下文时重复生成发现内容。

- **Phase 4 覆盖矩阵系统** - 引入覆盖检查机制，确保最终研究报告系统性地回答所有研究目标和组成问题。新增 `coverage.json` 生成步骤，自动验证大纲章节与证据目录的对应关系，防止遗漏关键内容。

- **跨语言处理增强** - 全面优化多语言内容处理流程，明确要求所有输出使用中文，同时保留原文引用。改进专业术语、专有名词的翻译策略，确保研究结果的专业性和可读性。

- **Bilibili 抓取器改进** - 修复硬编码路径问题，提升应用可移植性。新增 FFmpeg 路径自动配置功能，支持打包为可执行文件时的自动环境设置，无需手动配置系统 PATH。

### 新增功能

#### 研究功能增强
- **语义向量检索** - Phase 3 阶段支持 `request_type: "semantic"` 检索请求，基于向量嵌入进行语义相似度搜索。可指定 `source_link_ids` 或 `chunk_types` 进行定向检索，支持 `top_k` 参数控制返回结果数量。
- **智能检索增强** - 自动将关键词检索请求转换为语义检索，提升检索准确率。支持多轮语义检索（最多 3 轮），逐步细化检索范围。
- **Phase 3 文章生成** - 要求 AI 在每个研究步骤中生成完整的分析文章，不仅总结发现，还要提供深度推理和综合论证。文章需自然衔接上下文，合理引用证据和推理链。
- **覆盖矩阵验证** - Phase 4 合成前自动生成覆盖检查 JSON，验证大纲章节是否覆盖所有组成问题，标记部分覆盖或缺失的内容，提醒写作时补充。
- **条件性输出优化** - Phase 3 输出逻辑优化：当 `requests` 数组包含请求项时，`findings` 必须为 `null`，避免重复生成；只有在获得所有必要信息后才提供完整分析结果。

#### 向量检索配置
- **向量优先策略** - 新增 `research.retrieval.vector_first` 配置组，支持向量检索优先模式
  - `enabled`: 启用/禁用向量检索优先
  - `min_appended_chars`: 向量检索最小追加字符数（默认 600）
  - `max_sequential_windows`: 最大顺序窗口数（默认 3）
  - `max_block_chars`: 最大块字符数（默认 800）
  - `top_k`: 向量检索返回结果数（默认 12）
  - `max_rounds`: 最大检索轮数（默认 3）
  - `debug_logs`: 调试日志开关

#### 抓取器改进
- **Bilibili 视频抓取器增强**
  - 修复硬编码 Python 路径问题，使用 `sys.executable` 动态获取解释器路径
  - 新增 `_setup_ffmpeg_path()` 方法，自动检测并配置 FFmpeg 路径
  - 支持打包为可执行文件时的自动环境配置
  - 改进错误处理和日志记录

#### 提示词优化
- **Phase 3 指令增强**
  - 明确语言要求：所有输出必须使用中文，跨语言术语需提供原文对照
  - 优化内容检索指导，详细说明语义检索的使用场景和参数
  - 强化文章生成要求，强调深度分析和推理能力
  - 改进条件性输出示例，清晰展示请求上下文时的正确输出格式

- **Phase 4 指令完善**
  - 新增覆盖矩阵约束说明，要求逐条落实覆盖检查
  - 明确证据引用规范，所有分析性陈述需配套 `[EVID-##]` 引用
  - 增强缺口提示机制，要求标注证据不足时的后续建议
  - 优化附录规范，统一方法与来源说明、证据附录的格式要求

### 修复与改进

#### 稳定性提升
- **向量检索服务容错** - 改进向量检索服务的初始化逻辑，当服务不可用时优雅降级，不影响整体研究流程
- **检索请求验证** - 增强语义检索请求的参数验证，确保 `query` 参数存在，防止无效请求
- **输出格式一致性** - 修复 Phase 3 输出中 `findings` 字段的条件性要求，确保 JSON 格式严格符合 schema 定义
- **错误消息优化** - 改进向量检索失败时的错误提示，提供更清晰的诊断信息

#### 性能优化
- **向量检索效率** - 优化向量检索的批处理逻辑，减少不必要的数据库查询
- **检索结果去重** - 改进语义检索结果的去重机制，避免返回重复内容片段
- **上下文窗口管理** - 优化向量检索的上下文窗口处理，平衡检索精度与性能

#### 代码质量
- **模块化改进** - 将向量检索功能独立为 `VectorRetrievalService` 类，提升代码可维护性
- **类型注解增强** - 为向量检索相关函数补充类型提示，提升代码可读性
- **日志规范化** - 统一向量检索相关的日志格式，使用 `[PHASE3-VECTOR]` 前缀便于追踪

### 依赖更新

#### 后端依赖
- 向量检索功能依赖现有的向量存储和嵌入模块（已在 v1.2 中引入）
- 无需新增外部依赖，复用现有基础设施

#### 配置更新
- 新增 `research.retrieval.vector_first` 配置组（可选，默认启用）
- Bilibili 抓取器自动处理 FFmpeg 路径，无需额外配置

### 迁移指南

#### 从 v1.2 升级到 v1.3

1. **更新依赖**
   ```bash
   pip install -r requirements.txt --upgrade
   cd client && npm install
   ```

2. **更新配置文件（可选）**
   - 如需自定义向量检索行为，可在 `config.yaml` 中添加 `research.retrieval.vector_first` 配置组
   - 默认配置已优化，大多数用户无需修改

3. **验证向量检索**
   - 启动后端后，检查日志中是否出现 `[PHASE3-VECTOR] Vector retrieval service initialized`
   - 如向量服务不可用，系统会自动降级，不影响基本功能

4. **测试新功能**
   - 创建新的研究会话，验证 Phase 3 阶段的语义检索功能
   - 检查 Phase 4 生成的覆盖矩阵是否正常工作
   - 验证 Bilibili 视频抓取是否正常（如使用）

5. **清理旧会话（可选）**
   - v1.3 向后兼容 v1.2 的会话格式
   - 如遇到兼容性问题，可删除 `data/research/sessions/` 中的旧会话文件

### 已知问题

- **向量检索初始化** - 首次使用向量检索时，如向量数据库尚未建立，可能需要较长时间生成嵌入向量，请耐心等待
- **语义检索精度** - 对于非常专业或小众的术语，语义检索可能不如关键词检索精确，系统会自动降级到关键词检索
- **大规模数据集** - 处理超过 100,000 词的数据集时，向量检索可能较慢，建议调整 `top_k` 参数或增加系统内存

### 技术细节

#### 语义检索工作原理
1. **查询理解** - AI 分析研究步骤的目标，生成语义查询
2. **向量嵌入** - 将查询文本转换为向量表示
3. **相似度搜索** - 在向量数据库中搜索最相似的内容片段
4. **结果排序** - 按相似度分数排序，返回 top_k 个结果
5. **上下文提取** - 提取匹配片段及其周围上下文，提供给 AI 分析

#### 覆盖矩阵生成流程
1. **大纲分析** - 解析 Phase 2 生成的研究大纲
2. **目标映射** - 将组成问题映射到大纲章节
3. **证据关联** - 关联 Phase 3 生成的证据目录
4. **覆盖检查** - 验证每个目标是否被充分覆盖
5. **缺口标记** - 标记部分覆盖或缺失的内容，提醒 Phase 4 补充

### 致谢

感谢所有贡献者对 v1.3 版本的贡献，特别是在语义检索、Phase 3/4 提示词优化和 Bilibili 抓取器改进方面的努力。

---

**发布日期:** 2025-01-25  
**版本号:** v1.3.0  
**最低 Python 版本:** 3.9+  
**最低 Node.js 版本:** 18+

